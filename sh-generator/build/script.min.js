!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define("HX",e):e()}(0,function(){"use strict";class t{constructor(t){this.data=null,this.width=0,this.height=0,this._dataView=new DataView(t),this._exposure=1,this._colorCorr=[1,1,1],this._offset=0,this._parseHeader(),this._parseData(),this._dataView=null}_parseHeader(){let t=this._readLine();if("#?RADIANCE"!==t&&"#?RGBE"!==t)throw new Error("Incorrect file format!");for(;""!==t;){let e=(t=this._readLine()).split("=");switch(e[0]){case"GAMMA":this._gamma=parseFloat(e[1]);break;case"FORMAT":if("32-bit_rle_rgbe"!==e[1]&&"32-bit_rle_xyze"!==e[1])throw new Error("Incorrect encoding format!");break;case"EXPOSURE":this._exposure*=parseFloat(e[1]);break;case"COLORCORR":this._colorCorr=e[1].replace(/^\s+|\s+$/g,"").split(" ")}}let e=(t=this._readLine()).split(" ");this._parseSize(e[0],parseInt(e[1])),this._parseSize(e[2],parseInt(e[3]))}_parseSize(t,e){switch(t){case"+X":this.width=e;break;case"-X":this.width=e,console.warn("Flipping horizontal orientation not currently supported");break;case"-Y":this.height=e;break;case"+Y":this.height=e,console.warn("Flipping vertical orientation not currently supported")}}_readLine(){let t,e="";for(;10!==(t=this._dataView.getUint8(this._offset++));)e+=String.fromCharCode(t);return e}_parseData(){if(514!==this._dataView.getUint16(this._offset))throw new Error("Obsolete HDR file version!");this.data=this._parseNewRLE()}_parseNewRLE(){let t=this.width*this.height,e=this.width,i=new Float32Array(3*t),n=0,s=this._offset;for(let t=0;t<this.height;++t){if(514!==this._dataView.getUint16(s))throw new Error("Incorrect scanline start hash");if(this._dataView.getUint16(s+2)!==this.width)throw new Error("Scanline doesn't match picture dimension!");s+=4;let t=4*e,o=[],r=0;for(;r<t;){let t=this._dataView.getUint8(s++);if(t>128){let e=t-128;t=this._dataView.getUint8(s++);for(let i=0;i<e;++i)o[r++]=t}else for(let e=0;e<t;++e)o[r++]=this._dataView.getUint8(s++)}for(r=0;r<e;++r){let t=o[r],s=o[r+e],a=o[r+2*e],h=o[r+3*e];h=h?Math.pow(2,h-136):0,i[n++]=t*h*this._exposure*this._colorCorr[0],i[n++]=s*h*this._exposure*this._colorCorr[1],i[n++]=a*h*this._exposure*this._colorCorr[2]}}return i}}const e=.5*Math.sqrt(1/Math.PI),i=.5*Math.sqrt(3/Math.PI),n=.5*Math.sqrt(15/Math.PI),s=.25*Math.sqrt(5/Math.PI),o=.25*Math.sqrt(15/Math.PI);let r=[];const a=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],h=[e,i,i,i,n,n,s,n,o];class d{constructor(){this._p=0,this._len=0,this._sh=null,this.onComplete=null,this.onProgress=null,this.irradiance=!0,this._doPart=this._doPart.bind(this),this._finish=this._finish.bind(this)}generate(t){this._sh=[];for(let t=0;t<9;++t)this._sh[t]={r:0,g:0,b:0};this._p=0,this._width=t.width,this._height=t.height,this._data=t.data,this._numSamples=t.width*t.height,this._totalWeight=0,this._doPart()}_doPart(){for(let t=0;t<1e4;++t){let t=this._p%this._width,e=Math.floor(this._p/this._width),i=3*this._p;if(this._accumulate(t,e,this._data[i],this._data[i+1],this._data[i+2]),++this._p===this._numSamples)return void setTimeout(this._finish,0)}this.onProgress&&this.onProgress(this._p/this._numSamples),setTimeout(this._doPart,0)}_accumulate(t,e,i,n,s){let o=.5-(t/this._width*2-1),a=(e/this._height*2-1)*Math.PI/2,d=Math.cos(a),l=Math.cos(o*Math.PI)*d,c=-Math.sin(a),f=Math.sin(o*Math.PI)*d;r[0]=h[0],r[1]=h[1]*c,r[2]=h[2]*f,r[3]=h[3]*l,r[4]=h[4]*l*c,r[5]=h[5]*c*f,r[6]=h[6]*(3*f*f-1),r[7]=h[7]*f*l,r[8]=h[8]*(l*l-c*c);let u=d;this._totalWeight+=u;for(let t=0;t<9;++t){let e=this._sh[t];e.r+=r[t]*i*u,e.g+=r[t]*n*u,e.b+=r[t]*s*u}}_finish(){for(let t=0;t<9;++t){let e=this.irradiance?a[t]:1;e*=4*Math.PI/this._totalWeight;let i=this._sh[t];i.r*=e,i.g*=e,i.b*=e}this.onProgress&&this.onProgress(1),this.onComplete&&this.onComplete(this._sh)}}var l="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c=function(){try{return Function("return this")()||(0,eval)("this")}catch(t){return"object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof l&&l.global===l?l:this}}();function f(t,e,i){var n=new XMLHttpRequest;n.open("GET",t),n.responseType="blob",n.onload=function(){m(n.response,e,i)},n.onerror=function(){console.error("could not download file")},n.send()}function u(t){var e=new XMLHttpRequest;return e.open("HEAD",t,!1),e.send(),e.status>=200&&e.status<=299}function p(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(i){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var m=c.saveAs||"object"!=typeof window||window!==c?function(){}:"download"in HTMLAnchorElement.prototype?function(t,e,i){var n=c.URL||c.webkitURL,s=document.createElement("a");e=e||t.name||"download",s.download=e,s.rel="noopener","string"==typeof t?(s.href=t,s.origin!==location.origin?u(s.href)?f(t,e,i):p(s,s.target="_blank"):p(s)):(s.href=n.createObjectURL(t),setTimeout(function(){n.revokeObjectURL(s.href)},4e4),setTimeout(function(){p(s)},0))}:"msSaveOrOpenBlob"in navigator?function(t,e,i){if(e=e||t.name||"download","string"==typeof t)if(u(t))f(t,e,i);else{var n=document.createElement("a");n.href=t,n.target="_blank",setTimeout(function(){clikc(n)})}else navigator.msSaveOrOpenBlob(function(t,e){return void 0===e?e={autoBom:!1}:"object"!=typeof e&&(console.warn("Depricated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t}(t,i),e)}:function(t,e,i,n){if((n=n||open("","_blank"))&&(n.document.title=n.document.body.innerText="downloading..."),"string"==typeof t)return f(t,e,i);var s="application/octet-stream"===t.type,o=/constructor/i.test(c.HTMLElement)||c.safari,r=/CriOS\/[\d]+/.test(navigator.userAgent);if((r||s&&o)&&"object"==typeof FileReader){var a=new FileReader;a.onloadend=function(){var t=a.result;t=r?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=t:location=t,n=null},a.readAsDataURL(t)}else{var h=c.URL||c.webkitURL,d=h.createObjectURL(t);n?n.location=d:location.href=d,n=null,setTimeout(function(){h.revokeObjectURL(d)},4e4)}},_=c.saveAs=m.saveAs=m;let w=null;function g(t){t.preventDefault()}function y(t){if(t.preventDefault(),t.dataTransfer.items){for(let e=0;e<t.dataTransfer.items.length;e++)if("file"===t.dataTransfer.items[e].kind){b(t.dataTransfer.items[e].getAsFile())}}else for(let e=0;e<t.dataTransfer.files.length;e++)b(t.dataTransfer.files[e])}function b(e){document.getElementById("errorContainer").classList.add("hidden"),document.getElementById("startContainer").classList.add("hidden"),document.getElementById("endContainer").classList.add("hidden"),document.getElementById("progress").classList.remove("hidden");let i=new FileReader;i.onload=function(e){!function(e){let i;try{i=new t(e)}catch(t){n=t.message,document.getElementById("errorContainer").classList.remove("hidden"),document.getElementById("startContainer").classList.add("hidden"),document.getElementById("endContainer").classList.add("hidden"),document.getElementById("progress").classList.add("hidden"),document.getElementById("errorMessage").innerHTML=n}var n;let s=new d;s.onComplete=E,s.onProgress=v,s.irradiance=document.getElementById("irradianceCheck").checked,s.generate(i)}(e.target.result)},i.readAsArrayBuffer(e)}function v(t){document.getElementById("progressProgress").style.width=Math.floor(100*t)+"%"}function E(t){document.getElementById("progress").classList.add("hidden"),document.getElementById("endContainer").classList.remove("hidden");let e="# Generated with Helix\n",i=0;for(let n=0;n<3;++n){e+="\nl="+n+":\n";for(let s=-n;s<=n;++s)e+="m="+s+": ",e+=t[i].r+" "+t[i].g+" "+t[i].b+"\n",++i}w=e}function M(){var t=new Blob([w],{type:"text/plain;charset=utf-8"});_(t,"sh.ash")}window.addEventListener("load",function(){document.body.addEventListener("drop",y),document.body.addEventListener("dragover",g),document.getElementById("downloadButton").addEventListener("click",M)})});